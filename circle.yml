machine:
  environment:
    CIRCLE_BUILD_DIR: $HOME/$CIRCLE_PROJECT_REPONAME
    PATH: $PATH:$CIRCLE_BUILD_DIR/bin
  post:
    - mkdir -p $CIRCLE_BUILD_DIR/bin
  python:
    version: 2.7

dependencies:
  pre:
    - go get -v github.com/JacksonConsulting/s3up
  cache_directories:
    - bin
test:
  override:
    - ls -lR $VIRTUAL_ENV
deployment:
  zip:
    branch: master
    commands:
      - tmpdir=$(mktemp -d /tmp/lambda-XXXXXX)
      - zipfile=$tmpdir/route53_backups.zip
      - rsync -va $VIRTUAL_ENV/bin/cli53 $tmpdir/cli53
      - perl -pi -e '$_ = "#!/usr/bin/python\n" if $. == 1' $tmpdir/cli53
      - (cd $tmpdir; zip -r9 $zipfile cli53)
      - (cd $tmpdir; zip -r9 $zipfile functions/*)
  s3up:
    branch: master
    commands:
      - s3up -source=~/route53_backups.zip -bucket=$BUCKET
#  cli53:
#    branch: master
#    commands:
#      - cli53 list | grep 'Name:*' | cut -f6- -d' ' | while read line; do cli53 export ${line} >> backup/${line}bk; done
#  s3up:
#    branch: master
#    commands:
#      - s3up -source=backup/ -bucket=$BUCKET


#https://github.com/barnybug/cli53/releases/download/0.8.7/cli53-linux-amd64
#$ sudo mv cli53-my-platform /usr/local/bin/cli53
#$ sudo chmod +x /usr/local/bin/cli53
#
